<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>使用zlmediakit录像 | 张晓风的博客</title><meta name="author" content="张晓风"><meta name="copyright" content="张晓风"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="最近有项目需要后端录制视频，在朋友推荐下使用了 zlmediakit 服务，解决了录像录制的问题。  一、zlmediakit安装与配置使用 docker-compose 部署，将 conf 和 media 目录映射出来，方便配置文件的修改和录像等文件的持久化。docker-compose.yml 配置如下，我已经打开了推流录制，方便后面流程使用： 12345678910111213141516">
<meta property="og:type" content="article">
<meta property="og:title" content="使用zlmediakit录像">
<meta property="og:url" content="https://zhangyuliang1994.github.io/%E5%B7%A5%E5%85%B7-%E4%BD%BF%E7%94%A8zlmediakit%E5%BD%95%E5%83%8F/index.html">
<meta property="og:site_name" content="张晓风的博客">
<meta property="og:description" content="最近有项目需要后端录制视频，在朋友推荐下使用了 zlmediakit 服务，解决了录像录制的问题。  一、zlmediakit安装与配置使用 docker-compose 部署，将 conf 和 media 目录映射出来，方便配置文件的修改和录像等文件的持久化。docker-compose.yml 配置如下，我已经打开了推流录制，方便后面流程使用： 12345678910111213141516">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2024/01/23/uiAYVvz6TSpaqPB.jpg">
<meta property="article:published_time" content="2025-06-26T17:37:44.000Z">
<meta property="article:modified_time" content="2025-06-26T17:37:44.000Z">
<meta property="article:author" content="张晓风">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2024/01/23/uiAYVvz6TSpaqPB.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "使用zlmediakit录像",
  "url": "https://zhangyuliang1994.github.io/%E5%B7%A5%E5%85%B7-%E4%BD%BF%E7%94%A8zlmediakit%E5%BD%95%E5%83%8F/",
  "image": "https://s2.loli.net/2024/01/23/uiAYVvz6TSpaqPB.jpg",
  "datePublished": "2025-06-26T17:37:44.000Z",
  "dateModified": "2025-06-26T17:37:44.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "张晓风",
      "url": "https://zhangyuliang1994.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://s2.loli.net/2024/01/25/oc9IQwyfZJgTBAE.png"><link rel="canonical" href="https://zhangyuliang1994.github.io/%E5%B7%A5%E5%85%B7-%E4%BD%BF%E7%94%A8zlmediakit%E5%BD%95%E5%83%8F/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.4.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '使用zlmediakit录像',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.1.1"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://s2.loli.net/2024/01/23/uiAYVvz6TSpaqPB.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">张晓风的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">使用zlmediakit录像</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">使用zlmediakit录像</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-06-26T17:37:44.000Z" title="发表于 2025-06-26 17:37:44">2025-06-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-06-26T17:37:44.000Z" title="更新于 2025-06-26 17:37:44">2025-06-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>27分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="container post-content" id="article-container"><blockquote>
<p>最近有项目需要后端录制视频，在朋友推荐下使用了 zlmediakit 服务，解决了录像录制的问题。</p>
</blockquote>
<h2 id="一、zlmediakit安装与配置"><a href="#一、zlmediakit安装与配置" class="headerlink" title="一、zlmediakit安装与配置"></a>一、zlmediakit安装与配置</h2><p>使用 docker-compose 部署，将 conf 和 media 目录映射出来，方便配置文件的修改和录像等文件的持久化。<br>docker-compose.yml 配置如下，我已经打开了推流录制，方便后面流程使用：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.9&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zlmediakit:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-beijing.aliyuncs.com/wuhm/zlmediakit:master</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">zlmediakit</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 指定加载配置</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">/opt/media/bin/MediaServer</span> <span class="string">-c</span> <span class="string">/opt/media/conf/config.ini</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;11935:1935&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;180:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;1554:554&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9009:9000/udp&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;10000:10000/tcp&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;10000:10000/udp&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;30000-30500:30000-30500/tcp&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;30000-30500:30000-30500/udp&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment">#  自定义MediaServer</span></span><br><span class="line"> <span class="comment">#     - ./bin:/opt/media/bin</span></span><br><span class="line">      <span class="comment">#  自定义config.ini</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf/config.ini:/opt/media/conf/config.ini</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./media:/opt/media/bin/www</span></span><br><span class="line">      <span class="comment">#  自定义ffmpeg</span></span><br><span class="line">      <span class="comment"># - ./ffmpeg/bin:/home/bin</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">&quot;on-failure:3&quot;</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">driver:</span> <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">&quot;10m&quot;</span></span><br><span class="line">        <span class="attr">max-file:</span> <span class="string">&quot;3&quot;</span></span><br></pre></td></tr></table></figure>

<p>conf 目录下只有一个 config.ini 配置文件，比较重要的配置是 secret ，API 调用需要。内容如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!!!!此配置文件为范例配置文件，意在告诉读者，各个配置项的具体含义和作用，</span></span><br><span class="line"><span class="comment">#!!!!该配置文件在执行cmake时，会拷贝至release/$&#123;操作系统类型&#125;/$&#123;编译类型&#125;(例如release/linux/Debug) 文件夹。</span></span><br><span class="line"><span class="comment">#!!!!该文件夹(release/$&#123;操作系统类型&#125;/$&#123;编译类型&#125;)同时也是可执行程序生成目标路径，在执行MediaServer进程时，它会默认加载同目录下的config.ini文件作为配置文件，</span></span><br><span class="line"><span class="comment">#!!!!你如果修改此范例配置文件(conf/config.ini)，并不会被MediaServer进程加载，因为MediaServer进程默认加载的是release/$&#123;操作系统类型&#125;/$&#123;编译类型&#125;/config.ini。</span></span><br><span class="line"><span class="comment">#!!!!当然，你每次执行cmake，该文件确实会被拷贝至release/$&#123;操作系统类型&#125;/$&#123;编译类型&#125;/config.ini，</span></span><br><span class="line"><span class="comment">#!!!!但是一般建议你直接修改release/$&#123;操作系统类型&#125;/$&#123;编译类型&#125;/config.ini文件，修改此文件一般不起作用,除非你运行MediaServer时使用-c参数指定到此文件。</span></span><br><span class="line"></span><br><span class="line"><span class="section">[api]</span></span><br><span class="line"><span class="comment">#是否调试http api,启用调试后，会打印每次http请求的内容和回复</span></span><br><span class="line"><span class="attr">apiDebug</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">#一些比较敏感的http api在访问时需要提供secret，否则无权限调用</span></span><br><span class="line"><span class="comment">#如果是通过127.0.0.1访问,那么可以不提供secret</span></span><br><span class="line"><span class="attr">secret</span>=abcd123456qwerty</span><br><span class="line"><span class="comment">#截图保存路径根目录，截图通过http api(/index/api/getSnap)生成和获取</span></span><br><span class="line"><span class="attr">snapRoot</span>=./www/snap/</span><br><span class="line"><span class="comment">#默认截图图片，在启动FFmpeg截图后但是截图还未生成时，可以返回默认的预设图片</span></span><br><span class="line"><span class="attr">defaultSnap</span>=./www/logo.png</span><br><span class="line"><span class="comment">#downloadFile http接口可访问文件的根目录，支持多个目录，不同目录通过分号(;)分隔</span></span><br><span class="line"><span class="attr">downloadRoot</span>=./www</span><br><span class="line"></span><br><span class="line"><span class="section">[ffmpeg]</span></span><br><span class="line"><span class="comment">#FFmpeg可执行程序路径,支持相对路径/绝对路径</span></span><br><span class="line"><span class="attr">bin</span>=/usr/bin/ffmpeg</span><br><span class="line"><span class="comment">#FFmpeg拉流再推流的命令模板，通过该模板可以设置再编码的一些参数</span></span><br><span class="line"><span class="attr">cmd</span>=%s -re -i %s -c:a aac -strict -<span class="number">2</span> -ar <span class="number">44100</span> -ab <span class="number">48</span>k -c:v libx264 -f flv %s</span><br><span class="line"><span class="comment">#FFmpeg生成截图的命令，可以通过修改该配置改变截图分辨率或质量</span></span><br><span class="line"><span class="attr">snap</span>=%s -i %s -y -f mjpeg -frames:v <span class="number">1</span> -an %s</span><br><span class="line"><span class="comment">#FFmpeg日志的路径，如果置空则不生成FFmpeg日志</span></span><br><span class="line"><span class="comment">#可以为相对(相对于本可执行程序目录)或绝对路径</span></span><br><span class="line"><span class="attr">log</span>=./ffmpeg/ffmpeg.log</span><br><span class="line"><span class="comment"># 自动重启的时间(秒), 默认为0, 也就是不自动重启. 主要是为了避免长时间ffmpeg拉流导致的不同步现象</span></span><br><span class="line"><span class="attr">restart_sec</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#转协议相关开关；如果addStreamProxy api和on_publish hook回复未指定转协议参数，则采用这些配置项</span></span><br><span class="line"><span class="section">[protocol]</span></span><br><span class="line"><span class="comment">#转协议时，是否开启帧级时间戳覆盖</span></span><br><span class="line"><span class="comment"># 0:采用源视频流绝对时间戳，不做任何改变</span></span><br><span class="line"><span class="comment"># 1:采用zlmediakit接收数据时的系统时间戳(有平滑处理)</span></span><br><span class="line"><span class="comment"># 2:采用源视频流时间戳相对时间戳(增长量)，有做时间戳跳跃和回退矫正</span></span><br><span class="line"><span class="attr">modify_stamp</span>=<span class="number">2</span></span><br><span class="line"><span class="comment">#转协议是否开启音频</span></span><br><span class="line"><span class="attr">enable_audio</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">#添加acc静音音频，在关闭音频时，此开关无效</span></span><br><span class="line"><span class="attr">add_mute_audio</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">#无人观看时，是否直接关闭(而不是通过on_none_reader hook返回close)</span></span><br><span class="line"><span class="comment">#此配置置1时，此流如果无人观看，将不触发on_none_reader hook回调，</span></span><br><span class="line"><span class="comment">#而是将直接关闭流</span></span><br><span class="line"><span class="attr">auto_close</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#推流断开后可以在超时时间内重新连接上继续推流，这样播放器会接着播放。</span></span><br><span class="line"><span class="comment">#置0关闭此特性(推流断开会导致立即断开播放器)</span></span><br><span class="line"><span class="comment">#此参数不应大于播放器超时时间;单位毫秒</span></span><br><span class="line"><span class="attr">continue_push_ms</span>=<span class="number">15000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#平滑发送定时器间隔，单位毫秒，置0则关闭；开启后影响cpu性能同时增加内存</span></span><br><span class="line"><span class="comment">#该配置开启后可以解决一些流发送不平滑导致zlmediakit转发也不平滑的问题</span></span><br><span class="line"><span class="attr">paced_sender_ms</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#是否开启转换为hls(mpegts)</span></span><br><span class="line"><span class="attr">enable_hls</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">#是否开启转换为hls(fmp4)</span></span><br><span class="line"><span class="attr">enable_hls_fmp4</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#是否开启MP4录制</span></span><br><span class="line"><span class="attr">enable_mp4</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">#是否开启转换为rtsp/webrtc</span></span><br><span class="line"><span class="attr">enable_rtsp</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">#是否开启转换为rtmp/flv</span></span><br><span class="line"><span class="attr">enable_rtmp</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">#是否开启转换为http-ts/ws-ts</span></span><br><span class="line"><span class="attr">enable_ts</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">#是否开启转换为http-fmp4/ws-fmp4</span></span><br><span class="line"><span class="attr">enable_fmp4</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#是否将mp4录制当做观看者</span></span><br><span class="line"><span class="attr">mp4_as_player</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#mp4切片大小，单位秒</span></span><br><span class="line"><span class="attr">mp4_max_second</span>=<span class="number">3600</span></span><br><span class="line"><span class="comment">#mp4录制保存路径</span></span><br><span class="line"><span class="attr">mp4_save_path</span>=./www</span><br><span class="line"></span><br><span class="line"><span class="comment">#hls录制保存路径</span></span><br><span class="line"><span class="attr">hls_save_path</span>=./www</span><br><span class="line"></span><br><span class="line"><span class="comment">###### 以下是按需转协议的开关，在测试ZLMediaKit的接收推流性能时，请把下面开关置1</span></span><br><span class="line"><span class="comment">###### 如果某种协议你用不到，你可以把以下开关置1以便节省资源(但是还是可以播放，只是第一个播放者体验稍微差点)，</span></span><br><span class="line"><span class="comment">###### 如果某种协议你想获取最好的用户体验，请置0(第一个播放者可以秒开，且不花屏)</span></span><br><span class="line"><span class="comment">#hls协议是否按需生成，如果hls.segNum配置为0(意味着hls录制)，那么hls将一直生成(不管此开关)</span></span><br><span class="line"><span class="attr">hls_demand</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#rtsp[s]协议是否按需生成</span></span><br><span class="line"><span class="attr">rtsp_demand</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#rtmp[s]、http[s]-flv、ws[s]-flv协议是否按需生成</span></span><br><span class="line"><span class="attr">rtmp_demand</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#http[s]-ts协议是否按需生成</span></span><br><span class="line"><span class="attr">ts_demand</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#http[s]-fmp4、ws[s]-fmp4协议是否按需生成</span></span><br><span class="line"><span class="attr">fmp4_demand</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[general]</span></span><br><span class="line"><span class="comment">#是否启用虚拟主机</span></span><br><span class="line"><span class="attr">enableVhost</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#播放器或推流器在断开后会触发hook.on_flow_report事件(使用多少流量事件)，</span></span><br><span class="line"><span class="comment">#flowThreshold参数控制触发hook.on_flow_report事件阈值，使用流量超过该阈值后才触发，单位KB</span></span><br><span class="line"><span class="attr">flowThreshold</span>=<span class="number">1024</span></span><br><span class="line"><span class="comment">#播放最多等待时间，单位毫秒</span></span><br><span class="line"><span class="comment">#播放在播放某个流时，如果该流不存在，</span></span><br><span class="line"><span class="comment">#ZLMediaKit会最多让播放器等待maxStreamWaitMS毫秒</span></span><br><span class="line"><span class="comment">#如果在这个时间内，该流注册成功，那么会立即返回播放器播放成功</span></span><br><span class="line"><span class="comment">#否则返回播放器未找到该流，该机制的目的是可以先播放再推流</span></span><br><span class="line"><span class="attr">maxStreamWaitMS</span>=<span class="number">15000</span></span><br><span class="line"><span class="comment">#某个流无人观看时，触发hook.on_stream_none_reader事件的最大等待时间，单位毫秒</span></span><br><span class="line"><span class="comment">#在配合hook.on_stream_none_reader事件时，可以做到无人观看自动停止拉流或停止接收推流</span></span><br><span class="line"><span class="attr">streamNoneReaderDelayMS</span>=<span class="number">20000</span></span><br><span class="line"><span class="comment">#拉流代理时如果断流再重连成功是否删除前一次的媒体流数据，如果删除将重新开始，</span></span><br><span class="line"><span class="comment">#如果不删除将会接着上一次的数据继续写(录制hls/mp4时会继续在前一个文件后面写)</span></span><br><span class="line"><span class="attr">resetWhenRePlay</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">#合并写缓存大小(单位毫秒)，合并写指服务器缓存一定的数据后才会一次性写入socket，这样能提高性能，但是会提高延时</span></span><br><span class="line"><span class="comment">#开启后会同时关闭TCP_NODELAY并开启MSG_MORE</span></span><br><span class="line"><span class="attr">mergeWriteMS</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#服务器唯一id，用于触发hook时区别是哪台服务器</span></span><br><span class="line"><span class="attr">mediaServerId</span>=your_server_id</span><br><span class="line"></span><br><span class="line"><span class="comment">#最多等待未初始化的Track时间，单位毫秒，超时之后会忽略未初始化的Track</span></span><br><span class="line"><span class="attr">wait_track_ready_ms</span>=<span class="number">10000</span></span><br><span class="line"><span class="comment">#如果流只有单Track，最多等待若干毫秒，超时后未收到其他Track的数据，则认为是单Track</span></span><br><span class="line"><span class="comment">#如果协议元数据有声明特定track数，那么无此等待时间</span></span><br><span class="line"><span class="attr">wait_add_track_ms</span>=<span class="number">3000</span></span><br><span class="line"><span class="comment">#如果track未就绪，我们先缓存帧数据，但是有最大个数限制，防止内存溢出</span></span><br><span class="line"><span class="attr">unready_frame_cache</span>=<span class="number">100</span></span><br><span class="line"><span class="comment">#是否启用观看人数变化事件广播，置1则启用，置0则关闭</span></span><br><span class="line"><span class="attr">broadcast_player_count_changed</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[hls]</span></span><br><span class="line"><span class="comment">#hls写文件的buf大小，调整参数可以提高文件io性能</span></span><br><span class="line"><span class="attr">fileBufSize</span>=<span class="number">65536</span></span><br><span class="line"><span class="comment">#hls最大切片时间</span></span><br><span class="line"><span class="attr">segDur</span>=<span class="number">2</span></span><br><span class="line"><span class="comment">#m3u8索引中,hls保留切片个数(实际保留切片个数大2~3个)</span></span><br><span class="line"><span class="comment">#如果设置为0，则不删除切片，而是保存为点播</span></span><br><span class="line"><span class="attr">segNum</span>=<span class="number">3</span></span><br><span class="line"><span class="comment">#HLS切片延迟个数，大于0将生成hls_delay.m3u8文件，0则不生成</span></span><br><span class="line"><span class="attr">segDelay</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#HLS切片从m3u8文件中移除后，继续保留在磁盘上的个数</span></span><br><span class="line"><span class="attr">segRetain</span>=<span class="number">5</span></span><br><span class="line"><span class="comment">#是否广播 hls切片(ts/fmp4)完成通知(on_record_ts)</span></span><br><span class="line"><span class="attr">broadcastRecordTs</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#直播hls文件删除延时，单位秒，issue: #913</span></span><br><span class="line"><span class="attr">deleteDelaySec</span>=<span class="number">10</span></span><br><span class="line"><span class="comment">#是否保留hls文件，此功能部分等效于segNum=0的情况</span></span><br><span class="line"><span class="comment">#不同的是这个保留不会在m3u8文件中体现</span></span><br><span class="line"><span class="comment">#0为不保留，不起作用</span></span><br><span class="line"><span class="comment">#1为保留，则不删除hls文件，如果开启此功能，注意磁盘大小，或者定期手动清理hls文件</span></span><br><span class="line"><span class="attr">segKeep</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#如果设置为1，则第一个切片长度强制设置为1个GOP。当GOP小于segDur，可以提高首屏速度</span></span><br><span class="line"><span class="attr">fastRegister</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[hook]</span></span><br><span class="line"><span class="comment">#是否启用hook事件，启用后，推拉流都将进行鉴权</span></span><br><span class="line"><span class="attr">enable</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#播放器或推流器使用流量事件，置空则关闭</span></span><br><span class="line">on_flow_report=</span><br><span class="line"><span class="comment">#访问http文件鉴权事件，置空则关闭鉴权</span></span><br><span class="line">on_http_access=</span><br><span class="line"><span class="comment">#播放鉴权事件，置空则关闭鉴权</span></span><br><span class="line">on_play=</span><br><span class="line"><span class="comment">#推流鉴权事件，置空则关闭鉴权</span></span><br><span class="line">on_publish=</span><br><span class="line"><span class="comment">#录制mp4切片完成事件</span></span><br><span class="line">on_record_mp4=</span><br><span class="line"><span class="comment"># 录制 hls ts(或fmp4) 切片完成事件</span></span><br><span class="line">on_record_ts=</span><br><span class="line"><span class="comment">#rtsp播放鉴权事件，此事件中比对rtsp的用户名密码</span></span><br><span class="line">on_rtsp_auth=</span><br><span class="line"><span class="comment">#rtsp播放是否开启专属鉴权事件，置空则关闭rtsp鉴权。rtsp播放鉴权还支持url方式鉴权</span></span><br><span class="line"><span class="comment">#建议开发者统一采用url参数方式鉴权，rtsp用户名密码鉴权一般在设备上用的比较多</span></span><br><span class="line"><span class="comment">#开启rtsp专属鉴权后，将不再触发on_play鉴权事件</span></span><br><span class="line">on_rtsp_realm=</span><br><span class="line"><span class="comment">#远程telnet调试鉴权事件</span></span><br><span class="line">on_shell_login=</span><br><span class="line"><span class="comment">#直播流注册或注销事件</span></span><br><span class="line">on_stream_changed=</span><br><span class="line"><span class="comment">#过滤on_stream_changed hook的协议类型，可以选择只监听某些感兴趣的协议；置空则不过滤协议</span></span><br><span class="line"><span class="attr">stream_changed_schemas</span>=rtsp/rtmp/fmp4/ts/hls/hls.fmp4</span><br><span class="line"><span class="comment">#无人观看流事件，通过该事件，可以选择是否关闭无人观看的流。配合general.streamNoneReaderDelayMS选项一起使用</span></span><br><span class="line">on_stream_none_reader=</span><br><span class="line"><span class="comment">#播放时，未找到流事件，通过配合hook.on_stream_none_reader事件可以完成按需拉流</span></span><br><span class="line">on_stream_not_found=</span><br><span class="line"><span class="comment">#服务器启动报告，可以用于服务器的崩溃重启事件监听</span></span><br><span class="line">on_server_started=</span><br><span class="line"><span class="comment">#服务器退出报告，当服务器正常退出时触发</span></span><br><span class="line">on_server_exited=</span><br><span class="line"><span class="comment">#server保活上报</span></span><br><span class="line">on_server_keepalive=</span><br><span class="line"><span class="comment">#发送rtp(startSendRtp)被动关闭时回调</span></span><br><span class="line">on_send_rtp_stopped=</span><br><span class="line"><span class="comment">#rtp server 超时未收到数据</span></span><br><span class="line">on_rtp_server_timeout=</span><br><span class="line"></span><br><span class="line"><span class="comment">#hook api最大等待回复时间，单位秒</span></span><br><span class="line"><span class="attr">timeoutSec</span>=<span class="number">10</span></span><br><span class="line"><span class="comment">#keepalive hook触发间隔,单位秒，float类型</span></span><br><span class="line"><span class="attr">alive_interval</span>=<span class="number">10.0</span></span><br><span class="line"><span class="comment">#hook通知失败重试次数,正整数。为0不重试，1时重试一次，以此类推</span></span><br><span class="line"><span class="attr">retry</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">#hook通知失败重试延时，单位秒，float型</span></span><br><span class="line"><span class="attr">retry_delay</span>=<span class="number">3.0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[cluster]</span></span><br><span class="line"><span class="comment">#设置源站拉流url模板, 格式跟printf类似，第一个%s指定app,第二个%s指定stream_id,</span></span><br><span class="line"><span class="comment">#开启集群模式后，on_stream_not_found和on_stream_none_reader hook将无效.</span></span><br><span class="line"><span class="comment">#溯源模式支持以下类型:</span></span><br><span class="line"><span class="comment">#rtmp方式: rtmp://127.0.0.1:1935/%s/%s</span></span><br><span class="line"><span class="comment">#rtsp方式: rtsp://127.0.0.1:554/%s/%s</span></span><br><span class="line"><span class="comment">#hls方式: http://127.0.0.1:80/%s/%s/hls.m3u8</span></span><br><span class="line"><span class="comment">#http-ts方式: http://127.0.0.1:80/%s/%s.live.ts</span></span><br><span class="line"><span class="comment">#支持多个源站，不同源站通过分号(;)分隔</span></span><br><span class="line">origin_url=</span><br><span class="line"><span class="comment">#溯源总超时时长，单位秒，float型；假如源站有3个，那么单次溯源超时时间为timeout_sec除以3</span></span><br><span class="line"><span class="comment">#单次溯源超时时间不要超过general.maxStreamWaitMS配置</span></span><br><span class="line"><span class="attr">timeout_sec</span>=<span class="number">15</span></span><br><span class="line"><span class="comment">#溯源失败尝试次数，-1时永久尝试</span></span><br><span class="line"><span class="attr">retry_count</span>=<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="section">[http]</span></span><br><span class="line"><span class="comment">#http服务器字符编码集</span></span><br><span class="line"><span class="attr">charSet</span>=utf-<span class="number">8</span></span><br><span class="line"><span class="comment">#http链接超时时间</span></span><br><span class="line"><span class="attr">keepAliveSecond</span>=<span class="number">30</span></span><br><span class="line"><span class="comment">#http请求体最大字节数，如果post的body太大，则不适合缓存body在内存</span></span><br><span class="line"><span class="attr">maxReqSize</span>=<span class="number">40960</span></span><br><span class="line"><span class="comment">#404网页内容，用户可以自定义404网页</span></span><br><span class="line"><span class="comment">#notFound=&lt;html&gt;&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&lt;body bgcolor=&quot;white&quot;&gt;&lt;center&gt;&lt;h1&gt;您访问的资源不存在！&lt;/h1&gt;&lt;/center&gt;&lt;hr&gt;&lt;center&gt;ZLMediaKit-4.0&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="comment">#http服务器监听端口</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">80</span></span><br><span class="line"><span class="comment">#http文件服务器根目录</span></span><br><span class="line"><span class="comment">#可以为相对(相对于本可执行程序目录)或绝对路径</span></span><br><span class="line"><span class="attr">rootPath</span>=./www</span><br><span class="line"><span class="comment">#http文件服务器读文件缓存大小，单位BYTE，调整该参数可以优化文件io性能</span></span><br><span class="line"><span class="attr">sendBufSize</span>=<span class="number">65536</span></span><br><span class="line"><span class="comment">#https服务器监听端口</span></span><br><span class="line"><span class="attr">sslport</span>=<span class="number">443</span></span><br><span class="line"><span class="comment">#是否显示文件夹菜单，开启后可以浏览文件夹</span></span><br><span class="line"><span class="attr">dirMenu</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">#虚拟目录, 虚拟目录名和文件路径使用&quot;,&quot;隔开，多个配置路径间用&quot;;&quot;隔开</span></span><br><span class="line"><span class="comment">#例如赋值为 app_a,/path/to/a;app_b,/path/to/b 那么</span></span><br><span class="line"><span class="comment">#访问 http://127.0.0.1/app_a/file_a 对应的文件路径为 /path/to/a/file_a</span></span><br><span class="line"><span class="comment">#访问 http://127.0.0.1/app_b/file_b 对应的文件路径为 /path/to/b/file_b</span></span><br><span class="line"><span class="comment">#访问其他http路径,对应的文件路径还是在rootPath内</span></span><br><span class="line">virtualPath=</span><br><span class="line"><span class="comment">#禁止后缀的文件使用mmap缓存，使用“,”隔开</span></span><br><span class="line"><span class="comment">#例如赋值为 .mp4,.flv</span></span><br><span class="line"><span class="comment">#那么访问后缀为.mp4与.flv 的文件不缓存</span></span><br><span class="line">forbidCacheSuffix=</span><br><span class="line"><span class="comment">#可以把http代理前真实客户端ip放在http头中：https://github.com/ZLMediaKit/ZLMediaKit/issues/1388</span></span><br><span class="line"><span class="comment">#切勿暴露此key，否则可能导致伪造客户端ip</span></span><br><span class="line">forwarded_ip_header=</span><br><span class="line"><span class="comment">#默认允许所有跨域请求</span></span><br><span class="line"><span class="attr">allow_cross_domains</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">#允许访问http api和http文件索引的ip地址范围白名单，置空情况下不做限制</span></span><br><span class="line"><span class="attr">allow_ip_range</span>=</span><br><span class="line"></span><br><span class="line"><span class="section">[multicast]</span></span><br><span class="line"><span class="comment">#rtp组播截止组播ip地址</span></span><br><span class="line"><span class="attr">addrMax</span>=<span class="number">239.255</span>.<span class="number">255.255</span></span><br><span class="line"><span class="comment">#rtp组播起始组播ip地址</span></span><br><span class="line"><span class="attr">addrMin</span>=<span class="number">239.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="comment">#组播udp ttl</span></span><br><span class="line"><span class="attr">udpTTL</span>=<span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="section">[record]</span></span><br><span class="line"><span class="comment">#mp4录制或mp4点播的应用名，通过限制应用名，可以防止随意点播</span></span><br><span class="line"><span class="comment">#点播的文件必须放置在此文件夹下</span></span><br><span class="line"><span class="attr">appName</span>=record</span><br><span class="line"><span class="comment">#mp4录制写文件缓存，单位BYTE,调整参数可以提高文件io性能</span></span><br><span class="line"><span class="attr">fileBufSize</span>=<span class="number">65536</span></span><br><span class="line"><span class="comment">#mp4点播每次流化数据量，单位毫秒，</span></span><br><span class="line"><span class="comment">#减少该值可以让点播数据发送量更平滑，增大该值则更节省cpu资源</span></span><br><span class="line"><span class="attr">sampleMS</span>=<span class="number">500</span></span><br><span class="line"><span class="comment">#mp4录制完成后是否进行二次关键帧索引写入头部</span></span><br><span class="line"><span class="attr">fastStart</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#MP4点播(rtsp/rtmp/http-flv/ws-flv)是否循环播放文件</span></span><br><span class="line"><span class="attr">fileRepeat</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#MP4录制写文件格式是否采用fmp4，启用的话，断电未完成录制的文件也能正常打开</span></span><br><span class="line"><span class="attr">enableFmp4</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[rtmp]</span></span><br><span class="line"><span class="comment">#rtmp必须在此时间内完成握手，否则服务器会断开链接，单位秒</span></span><br><span class="line"><span class="attr">handshakeSecond</span>=<span class="number">15</span></span><br><span class="line"><span class="comment">#rtmp超时时间，如果该时间内未收到客户端的数据，</span></span><br><span class="line"><span class="comment">#或者tcp发送缓存超过这个时间，则会断开连接，单位秒</span></span><br><span class="line"><span class="attr">keepAliveSecond</span>=<span class="number">15</span></span><br><span class="line"><span class="comment">#rtmp服务器监听端口</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">1935</span></span><br><span class="line"><span class="comment">#rtmps服务器监听地址</span></span><br><span class="line"><span class="attr">sslport</span>=<span class="number">0</span></span><br><span class="line"><span class="comment"># rtmp是否直接代理模式</span></span><br><span class="line"><span class="attr">directProxy</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">#h265 rtmp打包采用增强型rtmp标准还是国内拓展标准</span></span><br><span class="line"><span class="attr">enhanced</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[rtp]</span></span><br><span class="line"><span class="comment">#音频mtu大小，该参数限制rtp最大字节数，推荐不要超过1400</span></span><br><span class="line"><span class="comment">#加大该值会明显增加直播延时</span></span><br><span class="line"><span class="attr">audioMtuSize</span>=<span class="number">600</span></span><br><span class="line"><span class="comment">#视频mtu大小，该参数限制rtp最大字节数，推荐不要超过1400</span></span><br><span class="line"><span class="attr">videoMtuSize</span>=<span class="number">1400</span></span><br><span class="line"><span class="comment">#rtp包最大长度限制，单位KB,主要用于识别TCP上下文破坏时，获取到错误的rtp</span></span><br><span class="line"><span class="attr">rtpMaxSize</span>=<span class="number">10</span></span><br><span class="line"><span class="comment"># rtp 打包时，低延迟开关，默认关闭（为0），h264存在一帧多个slice（NAL）的情况，在这种情况下，如果开启可能会导致画面花屏</span></span><br><span class="line"><span class="attr">lowLatency</span>=<span class="number">0</span></span><br><span class="line"><span class="comment"># H264 rtp打包模式是否采用stap-a模式(为了在老版本浏览器上兼容webrtc)还是采用Single NAL unit packet per H.264 模式</span></span><br><span class="line"><span class="comment"># 有些老的rtsp设备不支持stap-a rtp，设置此配置为0可提高兼容性</span></span><br><span class="line"><span class="attr">h264_stap_a</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[rtp_proxy]</span></span><br><span class="line"><span class="comment">#导出调试数据(包括rtp/ps/h264)至该目录,置空则关闭数据导出</span></span><br><span class="line">dumpDir=</span><br><span class="line"><span class="comment">#udp和tcp代理服务器，支持rtp(必须是ts或ps类型)代理</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">10000</span></span><br><span class="line"><span class="comment">#rtp超时时间，单位秒</span></span><br><span class="line"><span class="attr">timeoutSec</span>=<span class="number">15</span></span><br><span class="line"><span class="comment">#随机端口范围，最少确保36个端口</span></span><br><span class="line"><span class="comment">#该范围同时限制rtsp服务器udp端口范围</span></span><br><span class="line"><span class="attr">port_range</span>=<span class="number">30000</span>-<span class="number">35000</span></span><br><span class="line"><span class="comment">#rtp h264 负载的pt</span></span><br><span class="line"><span class="attr">h264_pt</span>=<span class="number">98</span></span><br><span class="line"><span class="comment">#rtp h265 负载的pt</span></span><br><span class="line"><span class="attr">h265_pt</span>=<span class="number">99</span></span><br><span class="line"><span class="comment">#rtp ps 负载的pt</span></span><br><span class="line"><span class="attr">ps_pt</span>=<span class="number">96</span></span><br><span class="line"><span class="comment">#rtp opus 负载的pt</span></span><br><span class="line"><span class="attr">opus_pt</span>=<span class="number">100</span></span><br><span class="line"><span class="comment">#RtpSender相关功能是否提前开启gop缓存优化级联秒开体验，默认开启</span></span><br><span class="line"><span class="comment">#如果不调用startSendRtp相关接口，可以置0节省内存</span></span><br><span class="line"><span class="attr">gop_cache</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#国标发送g711 rtp 打包时，每个包的语音时长是多少，默认是100 ms，范围为20~180ms (gb28181-2016，c.2.4规定)，</span></span><br><span class="line"><span class="comment">#最好为20 的倍数，程序自动向20的倍数取整</span></span><br><span class="line"><span class="attr">rtp_g711_dur_ms</span> = <span class="number">100</span></span><br><span class="line"><span class="comment">#udp接收数据socket buffer大小配置</span></span><br><span class="line"><span class="comment">#4*1024*1024=4196304</span></span><br><span class="line"><span class="attr">udp_recv_socket_buffer</span>=<span class="number">4194304</span></span><br><span class="line"></span><br><span class="line"><span class="section">[rtc]</span></span><br><span class="line"><span class="comment">#rtc播放推流、播放超时时间</span></span><br><span class="line"><span class="attr">timeoutSec</span>=<span class="number">15</span></span><br><span class="line"><span class="comment">#本机对rtc客户端的可见ip，作为服务器时一般为公网ip，可有多个，用&#x27;,&#x27;分开，当置空时，会自动获取网卡ip</span></span><br><span class="line"><span class="comment">#同时支持环境变量，以$开头，如&quot;$EXTERN_IP&quot;; 请参考：https://github.com/ZLMediaKit/ZLMediaKit/pull/1786</span></span><br><span class="line">externIP=</span><br><span class="line"><span class="comment">#rtc udp服务器监听端口号，所有rtc客户端将通过该端口传输stun/dtls/srtp/srtcp数据，</span></span><br><span class="line"><span class="comment">#该端口是多线程的，同时支持客户端网络切换导致的连接迁移</span></span><br><span class="line"><span class="comment">#需要注意的是，如果服务器在nat内，需要做端口映射时，必须确保外网映射端口跟该端口一致</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">8000</span></span><br><span class="line"><span class="comment">#rtc tcp服务器监听端口号，在udp 不通的情况下，会使用tcp传输数据</span></span><br><span class="line"><span class="comment">#该端口是多线程的，同时支持客户端网络切换导致的连接迁移</span></span><br><span class="line"><span class="comment">#需要注意的是，如果服务器在nat内，需要做端口映射时，必须确保外网映射端口跟该端口一致</span></span><br><span class="line"><span class="attr">tcpPort</span> = <span class="number">8000</span></span><br><span class="line"><span class="comment">#设置remb比特率，非0时关闭twcc并开启remb。该设置在rtc推流时有效，可以控制推流画质</span></span><br><span class="line"><span class="comment">#目前已经实现twcc自动调整码率，关闭remb根据真实网络状况调整码率</span></span><br><span class="line"><span class="attr">rembBitRate</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#rtc支持的音频codec类型,在前面的优先级更高</span></span><br><span class="line"><span class="comment">#以下范例为所有支持的音频codec</span></span><br><span class="line"><span class="attr">preferredCodecA</span>=PCMA,PCMU,opus,mpeg4-generic</span><br><span class="line"><span class="comment">#rtc支持的视频codec类型,在前面的优先级更高</span></span><br><span class="line"><span class="comment">#以下范例为所有支持的视频codec</span></span><br><span class="line"><span class="attr">preferredCodecV</span>=H264,H265,AV1,VP9,VP8</span><br><span class="line"></span><br><span class="line"><span class="comment">#webrtc比特率设置</span></span><br><span class="line"><span class="attr">start_bitrate</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">max_bitrate</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">min_bitrate</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#nack接收端</span></span><br><span class="line"><span class="comment">#Nack缓存包最早时间间隔</span></span><br><span class="line"><span class="attr">maxNackMS</span>=<span class="number">5000</span></span><br><span class="line"><span class="comment">#Nack包检查间隔(包数量)</span></span><br><span class="line"><span class="attr">rtpCacheCheckInterval</span>=<span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#nack发送端</span></span><br><span class="line"><span class="comment">#最大保留的rtp丢包状态个数</span></span><br><span class="line"><span class="attr">nackMaxSize</span>=<span class="number">2048</span></span><br><span class="line"><span class="comment">#rtp丢包状态最长保留时间</span></span><br><span class="line"><span class="attr">nackMaxMS</span>=<span class="number">3000</span></span><br><span class="line"><span class="comment">#nack最多请求重传次数</span></span><br><span class="line"><span class="attr">nackMaxCount</span>=<span class="number">15</span></span><br><span class="line"><span class="comment">#nack重传频率，rtt的倍数</span></span><br><span class="line"><span class="attr">nackIntervalRatio</span>=<span class="number">1.0</span></span><br><span class="line"><span class="comment">#nack包中rtp个数，减小此值可以让nack包响应更灵敏</span></span><br><span class="line"><span class="attr">nackRtpSize</span>=<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="section">[srt]</span></span><br><span class="line"><span class="comment">#srt播放推流、播放超时时间,单位秒</span></span><br><span class="line"><span class="attr">timeoutSec</span>=<span class="number">5</span></span><br><span class="line"><span class="comment">#srt udp服务器监听端口号，所有srt客户端将通过该端口传输srt数据，</span></span><br><span class="line"><span class="comment">#该端口是多线程的，同时支持客户端网络切换导致的连接迁移</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">9000</span></span><br><span class="line"><span class="comment">#srt 协议中延迟缓存的估算参数，在握手阶段估算rtt ,然后latencyMul*rtt 为最大缓存时长，此参数越大，表示等待重传的时长就越大</span></span><br><span class="line"><span class="attr">latencyMul</span>=<span class="number">4</span></span><br><span class="line"><span class="comment">#包缓存的大小</span></span><br><span class="line"><span class="attr">pktBufSize</span>=<span class="number">8192</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[rtsp]</span></span><br><span class="line"><span class="comment">#rtsp专有鉴权方式是采用base64还是md5方式</span></span><br><span class="line"><span class="attr">authBasic</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#rtsp拉流、推流代理是否是直接代理模式</span></span><br><span class="line"><span class="comment">#直接代理后支持任意编码格式，但是会导致GOP缓存无法定位到I帧，可能会导致开播花屏</span></span><br><span class="line"><span class="comment">#并且如果是tcp方式拉流，如果rtp大于mtu会导致无法使用udp方式代理</span></span><br><span class="line"><span class="comment">#假定您的拉流源地址不是264或265或AAC，那么你可以使用直接代理的方式来支持rtsp代理</span></span><br><span class="line"><span class="comment">#如果你是rtsp推拉流，但是webrtc播放，也建议关闭直接代理模式，</span></span><br><span class="line"><span class="comment">#因为直接代理时，rtp中可能没有sps pps,会导致webrtc无法播放; 另外webrtc也不支持Single NAL Unit Packets类型rtp</span></span><br><span class="line"><span class="comment">#默认开启rtsp直接代理，rtmp由于没有这些问题，是强制开启直接代理的</span></span><br><span class="line"><span class="attr">directProxy</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#rtsp必须在此时间内完成握手，否则服务器会断开链接，单位秒</span></span><br><span class="line"><span class="attr">handshakeSecond</span>=<span class="number">15</span></span><br><span class="line"><span class="comment">#rtsp超时时间，如果该时间内未收到客户端的数据，</span></span><br><span class="line"><span class="comment">#或者tcp发送缓存超过这个时间，则会断开连接，单位秒</span></span><br><span class="line"><span class="attr">keepAliveSecond</span>=<span class="number">15</span></span><br><span class="line"><span class="comment">#rtsp服务器监听地址</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">554</span></span><br><span class="line"><span class="comment">#rtsps服务器监听地址</span></span><br><span class="line"><span class="attr">sslport</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#rtsp 转发是否使用低延迟模式，当开启时，不会缓存rtp包，来提高并发，可以降低一帧的延迟</span></span><br><span class="line"><span class="attr">lowLatency</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">#强制协商rtp传输方式 (0:TCP,1:UDP,2:MULTICAST,-1:不限制)</span></span><br><span class="line"><span class="comment">#当客户端发起RTSP SETUP的时候如果传输类型和此配置不一致则返回461 Unsupported transport</span></span><br><span class="line"><span class="comment">#迫使客户端重新SETUP并切换到对应协议。目前支持FFMPEG和VLC</span></span><br><span class="line"><span class="attr">rtpTransportType</span>=<span class="number">0</span></span><br><span class="line"><span class="section">[shell]</span></span><br><span class="line"><span class="comment">#调试telnet服务器接受最大bufffer大小</span></span><br><span class="line"><span class="attr">maxReqSize</span>=<span class="number">1024</span></span><br><span class="line"><span class="comment">#调试telnet服务器监听端口</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>media 目录就是将一些录像等文件挂在出来，启动前建个空目录即可，如图所示：<br><img src="https://minio.xiaofeng.show/blog/2024/20250626174821.png" alt="image.png"><br>浏览器也可以直接访问这个文件，如图所示：<br><img src="https://minio.xiaofeng.show/blog/2024/20250626174929.png" alt="image.png"></p>
<h2 id="二、客户端推流"><a href="#二、客户端推流" class="headerlink" title="二、客户端推流"></a>二、客户端推流</h2><h3 id="2-1-依赖引入"><a href="#2-1-依赖引入" class="headerlink" title="2.1 依赖引入"></a>2.1 依赖引入</h3><p>可以直接用 FFmpeg，但我的开发语言是 Java，我发现有现成的包可用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- FFmpeg Java 包装器 --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bytedeco<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javacv-platform<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-开始推流"><a href="#2-2-开始推流" class="headerlink" title="2.2 开始推流"></a>2.2 开始推流</h3><p>这里推流拿到是一个未加密的flv地址。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// ZLMediaKit配置  </span></span><br><span class="line"><span class="type">String</span> <span class="variable">zlmHost</span> <span class="operator">=</span> <span class="string">&quot;10.64.5.85&quot;</span>;  </span><br><span class="line"><span class="type">String</span> <span class="variable">zlmApiPort</span> <span class="operator">=</span> <span class="string">&quot;180&quot;</span>;  </span><br><span class="line"><span class="type">String</span> <span class="variable">zlmRtmpPort</span> <span class="operator">=</span> <span class="string">&quot;11935&quot;</span>;  </span><br><span class="line"><span class="type">String</span> <span class="variable">zlmSecret</span> <span class="operator">=</span> <span class="string">&quot;abcd123456qwerty&quot;</span>;  </span><br><span class="line"><span class="type">String</span> <span class="variable">appName</span> <span class="operator">=</span> <span class="string">&quot;live&quot;</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 生成流ID  </span></span><br><span class="line"><span class="type">String</span> <span class="variable">streamId</span> <span class="operator">=</span> <span class="string">&quot;device_&quot;</span> + deviceCode + <span class="string">&quot;_&quot;</span> + recordTask.getStartTime();  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 构建RTMP推流地址  </span></span><br><span class="line"><span class="type">String</span> <span class="variable">rtmpPushUrl</span> <span class="operator">=</span> String.format(<span class="string">&quot;rtmp://%s:%s/%s/%s&quot;</span>, zlmHost, zlmRtmpPort, appName, streamId);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 启动RTMP推流任务 (FLV -&gt; RTMP -&gt; ZLM) - 使用JavaCV  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startRtmpPushTask</span><span class="params">(String flvUrl, String rtmpPushUrl, String deviceCode, RecordTask recordTask)</span> &#123;  </span><br><span class="line">    <span class="comment">// 创建后台推流任务  </span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;  </span><br><span class="line">        <span class="type">FFmpegFrameGrabber</span> <span class="variable">grabber</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        <span class="type">FFmpegFrameRecorder</span> <span class="variable">recorder</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">          </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            log.info(<span class="string">&quot;开始RTMP推流: &#123;&#125; -&gt; &#123;&#125;&quot;</span>, flvUrl, rtmpPushUrl);  </span><br><span class="line">              </span><br><span class="line">            <span class="comment">// 1. 创建和配置输入抓取器  </span></span><br><span class="line">            grabber = createConfiguredGrabber(flvUrl);  </span><br><span class="line">            log.info(<span class="string">&quot;FFmpegFrameGrabber配置完成，开始启动...&quot;</span>);  </span><br><span class="line">            grabber.start();  </span><br><span class="line">            log.info(<span class="string">&quot;FFmpegFrameGrabber启动成功&quot;</span>);  </span><br><span class="line">              </span><br><span class="line">            <span class="comment">// 2. 获取流属性  </span></span><br><span class="line">            <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> grabber.getImageWidth();  </span><br><span class="line">            <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> grabber.getImageHeight();  </span><br><span class="line">            <span class="type">double</span> <span class="variable">frameRate</span> <span class="operator">=</span> grabber.getVideoFrameRate();  </span><br><span class="line">            <span class="keyword">if</span> (frameRate &lt;= <span class="number">0</span>) frameRate = <span class="number">25</span>;  </span><br><span class="line">              </span><br><span class="line">            log.info(<span class="string">&quot;流属性: 宽度=&#123;&#125;, 高度=&#123;&#125;, 帧率=&#123;&#125;&quot;</span>, width, height, frameRate);  </span><br><span class="line">              </span><br><span class="line">            <span class="comment">// 3. 创建和配置输出录制器  </span></span><br><span class="line">            recorder = <span class="keyword">new</span> <span class="title class_">FFmpegFrameRecorder</span>(rtmpPushUrl, width, height);  </span><br><span class="line">            recorder.setVideoCodec(avcodec.AV_CODEC_ID_H264);  </span><br><span class="line">            recorder.setFormat(<span class="string">&quot;flv&quot;</span>);  </span><br><span class="line">            recorder.setFrameRate(frameRate);  </span><br><span class="line">            recorder.setVideoBitrate(<span class="number">2000000</span>);  </span><br><span class="line">            recorder.setPixelFormat(org.bytedeco.ffmpeg.global.avutil.AV_PIX_FMT_YUV420P);  </span><br><span class="line">              </span><br><span class="line">            <span class="comment">// H264编码设置  </span></span><br><span class="line">            recorder.setOption(<span class="string">&quot;preset&quot;</span>, <span class="string">&quot;fast&quot;</span>);  </span><br><span class="line">            recorder.setOption(<span class="string">&quot;profile&quot;</span>, <span class="string">&quot;baseline&quot;</span>);  </span><br><span class="line">            recorder.setOption(<span class="string">&quot;level&quot;</span>, <span class="string">&quot;3.1&quot;</span>);  </span><br><span class="line">              </span><br><span class="line">            <span class="comment">// RTMP特定设置  </span></span><br><span class="line">            recorder.setOption(<span class="string">&quot;rtmp_live&quot;</span>, <span class="string">&quot;live&quot;</span>);  </span><br><span class="line">            recorder.setOption(<span class="string">&quot;rtmp_buffer&quot;</span>, <span class="string">&quot;1000&quot;</span>);  </span><br><span class="line">              </span><br><span class="line">            <span class="comment">// 音频配置  </span></span><br><span class="line">            <span class="keyword">if</span> (grabber.getAudioChannels() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">                recorder.setAudioChannels(<span class="number">1</span>);  </span><br><span class="line">                recorder.setAudioCodec(avcodec.AV_CODEC_ID_AAC);  </span><br><span class="line">                recorder.setSampleRate(<span class="number">44100</span>);  </span><br><span class="line">                recorder.setAudioBitrate(<span class="number">64000</span>);  </span><br><span class="line">                log.info(<span class="string">&quot;音频配置: 通道=1, 采样率=44100, 比特率=64000&quot;</span>);  </span><br><span class="line">            &#125;  </span><br><span class="line">              </span><br><span class="line">            recorder.start();  </span><br><span class="line">              </span><br><span class="line">            <span class="comment">// 4. 保存到RecordTask以便生命周期管理  </span></span><br><span class="line">            recordTask.setPushRecorder(recorder);  </span><br><span class="line">            recordTask.setPushGrabber(grabber);  </span><br><span class="line">              </span><br><span class="line">            <span class="comment">// 5. 发送第一帧以建立流  </span></span><br><span class="line">            <span class="type">Frame</span> <span class="variable">firstFrame</span> <span class="operator">=</span> grabber.grabFrame();  </span><br><span class="line">            <span class="keyword">if</span> (firstFrame != <span class="literal">null</span>) &#123;  </span><br><span class="line">                firstFrame.timestamp = <span class="number">0</span>;  </span><br><span class="line">                recorder.record(firstFrame);  </span><br><span class="line">                recordTask.setFirstFrameSent(<span class="literal">true</span>);  </span><br><span class="line">                log.info(<span class="string">&quot;第一帧已发送，推流建立&quot;</span>);  </span><br><span class="line">            &#125;  </span><br><span class="line">              </span><br><span class="line">            <span class="comment">// 6. 持续推流循环，帧率控制  </span></span><br><span class="line">            <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();  </span><br><span class="line">            <span class="type">int</span> <span class="variable">frameCount</span> <span class="operator">=</span> <span class="number">1</span>;  </span><br><span class="line">            <span class="type">long</span> <span class="variable">frameIntervalMs</span> <span class="operator">=</span> (<span class="type">long</span>) (<span class="number">1000.0</span> / frameRate);  </span><br><span class="line">            <span class="type">long</span> <span class="variable">expectedNextFrameTime</span> <span class="operator">=</span> startTime + frameIntervalMs;  </span><br><span class="line">            <span class="type">long</span> <span class="variable">lastLogTime</span> <span class="operator">=</span> startTime;  </span><br><span class="line">              </span><br><span class="line">            <span class="keyword">while</span> (<span class="string">&quot;RECORDING&quot;</span>.equals(recordTask.getStatus())) &#123;  </span><br><span class="line">                <span class="type">Frame</span> <span class="variable">frame</span> <span class="operator">=</span> grabber.grabFrame();  </span><br><span class="line">                <span class="keyword">if</span> (frame == <span class="literal">null</span>) &#123;  </span><br><span class="line">                    log.warn(<span class="string">&quot;抓取到空帧，可能输入流结束&quot;</span>);  </span><br><span class="line">                    <span class="keyword">break</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">                  </span><br><span class="line">                <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();  </span><br><span class="line">                  </span><br><span class="line">                <span class="keyword">if</span> (currentTime &gt;= expectedNextFrameTime) &#123;  </span><br><span class="line">                    <span class="comment">// 设置连续时间戳  </span></span><br><span class="line">                    frame.timestamp = frameCount * <span class="number">1000000L</span> / (<span class="type">long</span>) frameRate;  </span><br><span class="line">                    recorder.record(frame);  </span><br><span class="line">                    frameCount++;  </span><br><span class="line">                    expectedNextFrameTime = startTime + (frameCount * frameIntervalMs);  </span><br><span class="line">                      </span><br><span class="line">                    <span class="comment">// 每30秒记录一次推流状态  </span></span><br><span class="line">                    <span class="keyword">if</span> (currentTime - lastLogTime &gt; <span class="number">30000</span>) &#123;  </span><br><span class="line">                        <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> (currentTime - startTime) / <span class="number">1000</span>;  </span><br><span class="line">                        <span class="type">double</span> <span class="variable">actualFps</span> <span class="operator">=</span> frameCount / (duration + <span class="number">0.001</span>);  </span><br><span class="line">                        log.info(<span class="string">&quot;推流进行中: 设备=&#123;&#125;, 时长=&#123;&#125;秒, 帧数=&#123;&#125;, 实际帧率=&#123;:.2f&#125;fps&quot;</span>,   </span><br><span class="line">                                deviceCode, duration, frameCount, actualFps);  </span><br><span class="line">                        lastLogTime = currentTime;  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                    <span class="comment">// 等待到下一帧时间  </span></span><br><span class="line">                    <span class="type">long</span> <span class="variable">sleepTime</span> <span class="operator">=</span> Math.min(expectedNextFrameTime - currentTime, <span class="number">10</span>);  </span><br><span class="line">                    <span class="keyword">if</span> (sleepTime &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">                        Thread.sleep(sleepTime);  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">              </span><br><span class="line">            <span class="type">long</span> <span class="variable">totalDuration</span> <span class="operator">=</span> (System.currentTimeMillis() - startTime) / <span class="number">1000</span>;  </span><br><span class="line">            log.info(<span class="string">&quot;推流完成: 设备=&#123;&#125;, 总时长=&#123;&#125;秒, 总帧数=&#123;&#125;, 平均帧率=&#123;:.2f&#125;fps&quot;</span>,   </span><br><span class="line">                    deviceCode, totalDuration, frameCount, frameCount / (totalDuration + <span class="number">0.001</span>));  </span><br><span class="line">              </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            log.error(<span class="string">&quot;RTMP推流异常: 设备=&#123;&#125;, 错误=&#123;&#125;&quot;</span>, deviceCode, e.getMessage(), e);  </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">            <span class="comment">// 清理资源  </span></span><br><span class="line">            <span class="keyword">if</span> (recorder != <span class="literal">null</span>) &#123;  </span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                    recorder.recordSamples(<span class="literal">null</span>); <span class="comment">// 发送结束信号  </span></span><br><span class="line">                    recorder.stop();  </span><br><span class="line">                    recorder.release();  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                    log.error(<span class="string">&quot;释放录制器失败&quot;</span>, e);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">if</span> (grabber != <span class="literal">null</span>) &#123;  </span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                    grabber.stop();  </span><br><span class="line">                    grabber.release();  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                    log.error(<span class="string">&quot;释放抓取器失败&quot;</span>, e);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="comment">// 从RecordTask中清除引用  </span></span><br><span class="line">            recordTask.setPushRecorder(<span class="literal">null</span>);  </span><br><span class="line">            recordTask.setPushGrabber(<span class="literal">null</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;, <span class="string">&quot;rtmp-push-&quot;</span> + deviceCode).start();  </span><br><span class="line">      </span><br><span class="line">    log.info(<span class="string">&quot;RTMP推流任务已启动: 设备=&#123;&#125;&quot;</span>, deviceCode);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、录像保存"><a href="#三、录像保存" class="headerlink" title="三、录像保存"></a>三、录像保存</h2><h3 id="3-1-启动ZLM录制"><a href="#3-1-启动ZLM录制" class="headerlink" title="3.1 启动ZLM录制"></a>3.1 启动ZLM录制</h3><p>这里zlm的配置与推流相同，streamId 也是推流后拿到的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 通过API启动ZLM录制  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startZLMRecordingViaAPI</span><span class="params">(String zlmHost, String zlmApiPort, String secret,  </span></span><br><span class="line"><span class="params">                                   String appName, String streamId)</span> &#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="comment">// 构建ZLM录制API请求  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">apiUrl</span> <span class="operator">=</span> String.format(<span class="string">&quot;http://%s:%s/index/api/startRecord&quot;</span>, zlmHost, zlmApiPort);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 录制参数 - 优化为1分钟分片  </span></span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        params.put(<span class="string">&quot;secret&quot;</span>, secret);  </span><br><span class="line">        params.put(<span class="string">&quot;type&quot;</span>, <span class="number">0</span>); <span class="comment">// 0=hls,1=mp4  </span></span><br><span class="line">        params.put(<span class="string">&quot;vhost&quot;</span>, <span class="string">&quot;__defaultVhost__&quot;</span>);  </span><br><span class="line">        params.put(<span class="string">&quot;app&quot;</span>, appName);  </span><br><span class="line">        params.put(<span class="string">&quot;stream&quot;</span>, streamId);  </span><br><span class="line">        params.put(<span class="string">&quot;customized_path&quot;</span>, <span class="string">&quot;/opt/media/record/&quot;</span> + streamId); <span class="comment">// 自定义录制路径  </span></span><br><span class="line">        params.put(<span class="string">&quot;max_second&quot;</span>, <span class="number">30</span>); <span class="comment">// 30秒分片  </span></span><br><span class="line">        params.put(<span class="string">&quot;continue_push_ms&quot;</span>, <span class="number">2000</span>); <span class="comment">// 断流后继续录制2秒  </span></span><br><span class="line">        params.put(<span class="string">&quot;enable_fmp4&quot;</span>, <span class="number">0</span>); <span class="comment">// 禁用fmp4，使用标准mp4  </span></span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 发送HTTP请求启动录制  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> sendHttpRequest(apiUrl, params);  </span><br><span class="line">        log.info(<span class="string">&quot;ZLM启动录制响应: &#123;&#125;&quot;</span>, response);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 检查响应结果  </span></span><br><span class="line">        <span class="keyword">if</span> (!response.contains(<span class="string">&quot;\&quot;code\&quot;:0&quot;</span>)) &#123;  </span><br><span class="line">            log.warn(<span class="string">&quot;ZLM启动录制可能失败，但继续尝试录制: &#123;&#125;&quot;</span>, response);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            log.info(<span class="string">&quot;ZLM录制启动成功，分片时长: 30秒&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        log.error(<span class="string">&quot;调用ZLM录制API失败&quot;</span>, e);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-停止ZLM录制"><a href="#3-2-停止ZLM录制" class="headerlink" title="3.2 停止ZLM录制"></a>3.2 停止ZLM录制</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 通过API停止ZLM录制  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopZLMRecordingViaAPI</span><span class="params">(String zlmHost, String zlmApiPort, String secret,  </span></span><br><span class="line"><span class="params">                                  String appName, String streamId)</span> &#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">apiUrl</span> <span class="operator">=</span> String.format(<span class="string">&quot;http://%s:%s/index/api/stopRecord&quot;</span>, zlmHost, zlmApiPort);  </span><br><span class="line">  </span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        params.put(<span class="string">&quot;secret&quot;</span>, secret);  </span><br><span class="line">        params.put(<span class="string">&quot;type&quot;</span>, <span class="number">0</span>); <span class="comment">// 与启动时保持一致  </span></span><br><span class="line">        params.put(<span class="string">&quot;vhost&quot;</span>, <span class="string">&quot;__defaultVhost__&quot;</span>);  </span><br><span class="line">        params.put(<span class="string">&quot;app&quot;</span>, appName);  </span><br><span class="line">        params.put(<span class="string">&quot;stream&quot;</span>, streamId);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> sendHttpRequest(apiUrl, params);  </span><br><span class="line">        log.info(<span class="string">&quot;ZLM停止录制响应: &#123;&#125;&quot;</span>, response);  </span><br><span class="line">  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        log.error(<span class="string">&quot;调用ZLM停止录制API失败&quot;</span>, e);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-获取录制文件"><a href="#3-3-获取录制文件" class="headerlink" title="3.3 获取录制文件"></a>3.3 获取录制文件</h3><p>获取录制文件需要一定时间，比如我录制5分钟的视频，可能要等上一两分钟才能在目录里找到文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 获取ZLM录制文件列表 - 只扫描实际目录  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getZLMRecordFiles</span><span class="params">(String zlmHost, String zlmApiPort, String streamId)</span> &#123;  </span><br><span class="line">    List&lt;String&gt; recordFiles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="comment">// 构建录制文件URL模式: http://zlmHost:zlmApiPort/record/live/streamId/  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">baseUrl</span> <span class="operator">=</span> String.format(<span class="string">&quot;http://%s:%s/record/live/%s&quot;</span>, zlmHost, zlmApiPort, streamId);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 获取当前日期，ZLM按日期创建录制目录  </span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();  </span><br><span class="line">        <span class="type">String</span> <span class="variable">dateStr</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd&quot;</span>));  </span><br><span class="line">        <span class="type">String</span> <span class="variable">recordDirUrl</span> <span class="operator">=</span> baseUrl + <span class="string">&quot;/&quot;</span> + dateStr + <span class="string">&quot;/&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        log.info(<span class="string">&quot;只通过目录扫描查找mp4文件: &#123;&#125;&quot;</span>, recordDirUrl);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 只使用目录扫描方法，不再尝试其他方法  </span></span><br><span class="line">        recordFiles = scanDirectoryForMp4Files(recordDirUrl);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (recordFiles.size() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">            log.info(<span class="string">&quot;目录扫描发现 &#123;&#125; 个mp4文件&quot;</span>, recordFiles.size());  </span><br><span class="line">            <span class="comment">// 输出文件列表用于调试  </span></span><br><span class="line">            <span class="keyword">if</span> (recordFiles.size() &lt;= <span class="number">10</span>) &#123;  </span><br><span class="line">                log.info(<span class="string">&quot;发现的文件列表: &#123;&#125;&quot;</span>, String.join(<span class="string">&quot;, &quot;</span>,   </span><br><span class="line">                    recordFiles.stream()  </span><br><span class="line">                        .map(url -&gt; url.substring(url.lastIndexOf(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>))  </span><br><span class="line">                        .collect(Collectors.toList())));  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            log.warn(<span class="string">&quot;目录扫描未发现任何mp4文件，检查目录: &#123;&#125;&quot;</span>, recordDirUrl);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        log.error(<span class="string">&quot;获取ZLM录制文件列表失败&quot;</span>, e);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> recordFiles;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正常录制成功后，可以在 zlmediakit 上查询到录制好的文件：<br><img src="https://minio.xiaofeng.show/blog/2024/20250726173530.png" alt="image.png"><br>有了视频文件，我们就可以做存储的工作了，我的做法是存放到 MinIO 上。</p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zhangyuliang1994.github.io">张晓风</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://zhangyuliang1994.github.io/%E5%B7%A5%E5%85%B7-%E4%BD%BF%E7%94%A8zlmediakit%E5%BD%95%E5%83%8F/">https://zhangyuliang1994.github.io/%E5%B7%A5%E5%85%B7-%E4%BD%BF%E7%94%A8zlmediakit%E5%BD%95%E5%83%8F/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://zhangyuliang1994.github.io" target="_blank">张晓风的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a></div><div class="post-share"><div class="social-share" data-image="https://s2.loli.net/2024/01/23/uiAYVvz6TSpaqPB.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.4/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3-DTM%E4%BA%8B%E5%8A%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="DTM事务学习笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">DTM事务学习笔记</div></div><div class="info-2"><div class="info-item-1">一、DTM是什么DTM是一款开源的分布式事务管理器，解决跨数据库、跨服务、跨语言栈更新数据的一致性问题。 二、DTM支持的事务类型有哪些？三、SAGA类型 Saga的核心思想是将长事务拆分为多个本地短事务，由Saga事务协调器协调，如果各个本地事务成功完成那就正常完成，如果某个步骤失败，则根据相反顺序一次调用补偿操作。  </div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/java-BigDecimal%E6%AF%94%E8%BE%83%E5%A4%A7%E5%B0%8F/" title="BigDecimal比较大小"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-22</div><div class="info-item-2">BigDecimal比较大小</div></div><div class="info-2"><div class="info-item-1"> 这个类是Java里精确计算的类，下面说一下BidDecimal大小、相等的判断  12BigDecimal a = new BigDecimal(1.0);BigDecimal b = BigDecimal.valueOf(1.000);  一、比较方法1int result = a.compareTo(b); 二、比较结果 -1 小于 0  等于 1  大于   判断时以大于0、小于0、等于0为条件。  </div></div></div></a><a class="pagination-related" href="/java-Java-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%AC%94%E8%AE%B0/" title="Java 线程池笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-03</div><div class="info-item-2">Java 线程池笔记</div></div><div class="info-2"><div class="info-item-1">一、线程池介绍顾名思义，线程池就是管理一系列线程的资源池，其提供了一种限制和管理线程资源的方式。每个线程池还维护一些基本统计信息，例如已完成任务的数量。 使用线程池的好处：  降低资源消耗。通过重复利用已创建的线程降低线程创建和销毁造成的消耗。 提高响应速度。当任务到达时，任务可以不需要等到线程创建就能立即执行。 提高线程的可管理性。线程是稀缺资源，如果无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一的分配，调优和监控。  二、ThreadPoolExecutor 类介绍ThreadPoolExecutor 类中提供的四个构造方法。我们来看最长的那个，其余三个都是在这个构造方法的基础上产生。 12345678910111213141516171819202122232425/** * 用给定的初始参数创建一个新的ThreadPoolExecutor。 */public ThreadPoolExecutor(int corePoolSize,//线程池的核心线程数量                          int maximumPoolSiz...</div></div></div></a><a class="pagination-related" href="/java-Java%E9%80%9A%E8%BF%87SSH%E8%BF%9E%E6%8E%A5%E8%B7%AF%E7%94%B1%E5%99%A8%EF%BC%8C%E8%BE%93%E5%85%A5%E5%91%BD%E4%BB%A4%E5%B9%B6%E8%AF%BB%E5%8F%96%E5%93%8D%E5%BA%94/" title="Java通过SSH连接路由器，输入命令并读取响应"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-20</div><div class="info-item-2">Java通过SSH连接路由器，输入命令并读取响应</div></div><div class="info-2"><div class="info-item-1"> 最近需要读取和修改华为路由器的配置，使用Java语言开发，通过SSH连接，输入命令并读取响应。  1.添加mwiede/jsch依赖 如果使用Maven，可以在pom.xml文件中添加以下依赖:1234567&lt;dependencies&gt;    &lt;dependency&gt;        &lt;groupId&gt;com.github.mwiede&lt;/groupId&gt;        &lt;artifactId&gt;jsch&lt;/artifactId&gt;        &lt;version&gt;0.2.15&lt;/version&gt;    &lt;/dependency&gt;&lt;/dependencies&gt; 如果使用Gradle，则添加到build.gradle文件:123dependencies &#123;    implementation &#x27;com.github.mwiede:jsch:0.2.15&#x27;&#125;  2.使用Jsch创建SSH连接，输入命令并返回响应1234567891...</div></div></div></a><a class="pagination-related" href="/spring-%E4%BD%BF%E7%94%A8Easy-Es%E5%AF%B9%E6%95%B0%E6%8D%AE%E5%81%9A%E5%A4%9A%E9%87%8D%E8%81%9A%E5%90%88/" title="使用Easy-Es对数据做多重聚合"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-02</div><div class="info-item-2">使用Easy-Es对数据做多重聚合</div></div><div class="info-2"><div class="info-item-1">一、引入依赖及配置1234&lt;dependency&gt;      &lt;groupId&gt;com.alibaba&lt;/groupId&gt;      &lt;artifactId&gt;easyexcel&lt;/artifactId&gt;  &lt;/dependency&gt;  123456789101112easy-es:    address: 127.0.0.1:9200    username: elastic    password: elastic    enable: true    global-config:      print-dsl: false      db-config:        map-underscore-to-camel-case: false        smartAddKeywordSuffix: false    async:      concurrent: 10  二、类构建（pojo、mapper、dao）2.1 实体类123456789101112131415161718192021222324...</div></div></div></a><a class="pagination-related" href="/spring-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%A1%E9%AA%8C%E6%B3%A8%E8%A7%A3/" title="自定义校验注解"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-11</div><div class="info-item-2">自定义校验注解</div></div><div class="info-2"><div class="info-item-1">一、背景近期在用 javax.validation 做校验的时候发现没有对 BigDecimal 类型进行校验的注解，便自己动手写了一个。 二、定义注解及校验类2.1 注解类123456789101112131415@Documented@Constraint(validatedBy = BigDecimalRangeValidator.class)@Target(ElementType.FIELD)@Retention(RetentionPolicy.RUNTIME)public @interface BigDecimalRange &#123;    double min() default Double.MIN_VALUE;    double max() default Double.MAX_VALUE;    String message() default &quot;Validation failed&quot;;    Class&lt;?&gt;[] groups() default &#123;&#125;;    Class&lt;? extends Pay...</div></div></div></a><a class="pagination-related" href="/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3-Centrifugo%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" title="Centrifugo安装与使用"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-09</div><div class="info-item-2">Centrifugo安装与使用</div></div><div class="info-2"><div class="info-item-1">一、安装使用 docker-compose 安装，指定 config.json 配置文件。 1234567891011121314version: &quot;3.9&quot;services:  centrifugo:    container_name: centrifugo    image: centrifugo/centrifugo:v5    volumes:      - ./config.json:/centrifugo/config.json    command: centrifugo -c config.json    ports:      - 8000:8000    ulimits:      nofile:        soft: 65535        hard: 65535 docker-compose.yml 如上所示，使用 v5 版本。 12345678910111213141516&#123;  &quot;token_hmac_secret_key&quot;: &quot;kkc_secret&quot;,  &quot;api_...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://s2.loli.net/2024/01/23/uiAYVvz6TSpaqPB.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">张晓风</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zhangyuliang1994"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81zlmediakit%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">一、zlmediakit安装与配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A8%E6%B5%81"><span class="toc-number">2.</span> <span class="toc-text">二、客户端推流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E4%BE%9D%E8%B5%96%E5%BC%95%E5%85%A5"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 依赖引入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%BC%80%E5%A7%8B%E6%8E%A8%E6%B5%81"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 开始推流</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%BD%95%E5%83%8F%E4%BF%9D%E5%AD%98"><span class="toc-number">3.</span> <span class="toc-text">三、录像保存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%90%AF%E5%8A%A8ZLM%E5%BD%95%E5%88%B6"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 启动ZLM录制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%81%9C%E6%AD%A2ZLM%E5%BD%95%E5%88%B6"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 停止ZLM录制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E8%8E%B7%E5%8F%96%E5%BD%95%E5%88%B6%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 获取录制文件</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E5%B7%A5%E5%85%B7-%E4%BD%BF%E7%94%A8zlmediakit%E5%BD%95%E5%83%8F/" title="使用zlmediakit录像">使用zlmediakit录像</a><time datetime="2025-06-26T17:37:44.000Z" title="发表于 2025-06-26 17:37:44">2025-06-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3-DTM%E4%BA%8B%E5%8A%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="DTM事务学习笔记">DTM事务学习笔记</a><time datetime="2025-04-23T11:13:41.000Z" title="发表于 2025-04-23 11:13:41">2025-04-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E8%BD%AF%E8%80%83-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E7%AC%AC%E4%B8%80%E7%AB%A0%E7%AC%94%E8%AE%B0/" title="计算机网络-第一章笔记">计算机网络-第一章笔记</a><time datetime="2025-03-02T16:17:01.000Z" title="发表于 2025-03-02 16:17:01">2025-03-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E7%9E%8E%E6%8A%98%E8%85%BE-%E5%8D%95%E7%BA%BF%E5%A4%8D%E7%94%A8-%E5%AE%B6%E9%87%8C%E5%AE%BD%E5%B8%A6/" title="单线复用--家里宽带">单线复用--家里宽带</a><time datetime="2025-03-01T21:05:21.000Z" title="发表于 2025-03-01 21:05:21">2025-03-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E8%BD%AF%E8%80%83-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-B%E7%AB%99%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/" title="计算机网络 - B站学习计划">计算机网络 - B站学习计划</a><time datetime="2025-02-12T20:35:38.000Z" title="发表于 2025-02-12 20:35:38">2025-02-12</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2024 - 2025 By 张晓风</span></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">苏ICP备2023046043号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.4.2"></script><script src="/js/main.js?v=5.4.2"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.xiaofeng.show',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://twikoo.xiaofeng.show',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    GLOBAL_CONFIG_SITE.pageType === 'post' && getCount()

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>